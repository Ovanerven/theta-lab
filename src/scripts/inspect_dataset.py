"""
Inspect the contents of a dataset .npz file generated by create_dataset.py
"""
import argparse
import numpy as np
from pathlib import Path


def inspect_dataset(npz_path: str):
    """Print detailed information about a dataset file."""
    path = Path(npz_path)
    if not path.exists():
        print(f"Error: File not found: {npz_path}")
        return
    
    print(f"Loading dataset: {path}")
    print("=" * 80)
    
    data = np.load(str(path))
    
    print("\nðŸ“¦ DATASET CONTENTS:")
    print("-" * 80)
    for key in data.keys():
        arr = data[key]
        print(f"\n{key}:")
        if arr.ndim == 0:
            print(f"  Type: scalar")
            print(f"  Value: {arr}")
        elif arr.ndim == 1 and len(arr) < 20:
            print(f"  Shape: {arr.shape}")
            print(f"  Values: {arr}")
        else:
            print(f"  Shape: {arr.shape}")
            print(f"  Dtype: {arr.dtype}")
            if arr.size > 0:
                print(f"  Range: [{arr.min():.3f}, {arr.max():.3f}]")
                print(f"  Mean: {arr.mean():.3f}")
                print(f"  Std: {arr.std():.3f}")
    
    print("\n" + "=" * 80)
    print("\nðŸ“Š DATASET SUMMARY:")
    print("-" * 80)
    
    y0 = data['y0']
    u_seq = data['u_seq']
    y_seq = data['y_seq']
    t_obs = data['t_obs']
    theta_true = data['theta_true']
    
    # Optional: per-sample kinetics (only if k_noise > 0)
    theta_full = data.get('theta_full', None)
    
    N, p_obs = y0.shape
    _, K, d_in = u_seq.shape
    
    dt = np.diff(t_obs)
    
    print(f"Number of samples (N): {N}")
    print(f"Number of intervals (K): {K}")
    print(f"Observed species (p_obs): {p_obs}")
    print(f"Control channels (d_in): {d_in}")
    print(f"\nTime span: {t_obs[-1]:.1f}s ({K} steps)")
    print(f"Average dt: {dt.mean():.3f}s")
    
    print(f"\nðŸ“ˆ DATA STATISTICS:")
    print("-" * 80)
    print(f"Initial observations y0:")
    print(f"  Range: [{y0.min():.3f}, {y0.max():.3f}]")
    print(f"  Mean: {y0.mean():.3f}")
    
    print(f"\nTrajectories y_seq:")
    print(f"  Range: [{y_seq.min():.3f}, {y_seq.max():.3f}]")
    print(f"  Mean: {y_seq.mean():.3f}")
    
    print(f"\nControl inputs u_seq:")
    print(f"  Range: [{u_seq.min():.3f}, {u_seq.max():.3f}]")
    print(f"  Mean: {u_seq.mean():.3f}")
    print(f"  Sparsity: {(u_seq == 0).sum() / u_seq.size * 100:.1f}% zeros")
    
    # Count bolus events per sample
    bolus_counts = (u_seq.sum(axis=2) > 0).sum(axis=1)
    print(f"  Bolus events per sample: min={bolus_counts.min()}, max={bolus_counts.max()}, mean={bolus_counts.mean():.1f}")
    
    print(f"\nKinetics parameters Î¸:")
    print(f"  Ground truth Î¸_true: {theta_true}")
    if theta_full is not None:
        print(f"  Per-sample Î¸_full range: [{theta_full.min():.3f}, {theta_full.max():.3f}]")
        print(f"  Per-sample Î¸_full std: {theta_full.std(axis=0).mean():.3f} (avg across params)")
    else:
        print(f"  Per-sample variation: None (all samples use Î¸_true)")
    
    print("\n" + "=" * 80)
    print("\nðŸ” SAMPLE 0 DETAILS:")
    print("-" * 80)
    
    print(f"Initial state y0[0]: {y0[0]}")
    print(f"\nFinal state y_seq[0, -1]: {y_seq[0, -1]}")
    if theta_full is not None:
        print(f"\nÎ¸_full[0]: {theta_full[0]}")
    else:
        print(f"\nÎ¸ (shared): {theta_true}")
    
    # Show first few timesteps with non-zero control
    nonzero_k = np.where(u_seq[0].sum(axis=1) > 0)[0][:5]
    if len(nonzero_k) > 0:
        print(f"\nFirst {len(nonzero_k)} control events (timestep, total_amount):")
        for k in nonzero_k:
            total = u_seq[0, k].sum()
            active_channels = np.where(u_seq[0, k] > 0)[0]
            print(f"  k={k}: total={total:.2f}, channels={active_channels.tolist()}")
    
    print("\n" + "=" * 80)


def main():
    parser = argparse.ArgumentParser(description="Inspect dataset .npz file contents")
    parser.add_argument("dataset", type=str, help="Path to .npz dataset file")
    args = parser.parse_args()
    
    inspect_dataset(args.dataset)


if __name__ == "__main__":
    main()
